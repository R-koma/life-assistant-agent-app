services:
  db:
    image: postgres:17-alpine
    container_name: life-assistant-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-life_assistant_db}
      POSTGRES_USER: ${POSTGRES_USER:-life_assistant_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change_this_secure_password}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --locale=C"
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_USER:-life_assistant_user} -d ${POSTGRES_DB:-life_assistant_db}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - life-assistant-network

  server:
    build:
      context: ./server
      dockerfile: Dockerfile
      target: dev
    container_name: life-assistant-server
    restart: unless-stopped
    user: "1001:1001"
    environment:
      DATABASE_URL_ASYNC: postgresql+asyncpg://${POSTGRES_USER:-life_assistant_user}:${POSTGRES_PASSWORD:-change_this_secure_password}@db:5432/${POSTGRES_DB:-life_assistant_db}
      DATABASE_URL_SYNC: postgresql+psycopg://${POSTGRES_USER:-life_assistant_user}:${POSTGRES_PASSWORD:-change_this_secure_password}@db:5432/${POSTGRES_DB:-life_assistant_db}
      ALEMBIC_MODE: ${ALEMBIC_MODE:-sync}
      PYTHON_ENV: ${PYTHON_ENV:-development}
      DEBUG: ${DEBUG:-true}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000}
    ports:
      - "${SERVER_PORT:-8000}:8000"
    volumes:
      - ./server:/app:cached
      - server_uv_cache:/home/fastapi/.cache/uv:rw
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c "import urllib.request; urllib.request.urlopen(''http://localhost:8000/health'').read()" || exit 1',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - life-assistant-network

  client:
    build:
      context: ./client
      dockerfile: Dockerfile
      target: dev
    container_name: life-assistant-client
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8000}
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
      CLERK_SECRET_KEY: ${CLERK_SECRET_KEY}
      NEXT_TELEMETRY_DISABLED: 1
      WATCHPACK_POLLING: "true"
    ports:
      - "${CLIENT_PORT:-3000}:3000"
    volumes:
      - ./client:/app:cached
      - client_node_modules:/app/node_modules
      - client_next:/app/.next
    depends_on:
      server:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'node -e "require(''http'').get(''http://localhost:3000/api/health'', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})" || exit 1',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - life-assistant-network

volumes:
  postgres_data:
    driver: local
    name: life-assistant-postgres-data
  server_uv_cache:
    driver: local
    name: life-assistant-server-uv-cache
  client_node_modules:
    driver: local
    name: life-assistant-client-node-modules
  client_next:
    driver: local
    name: life-assistant-client-next

networks:
  life-assistant-network:
    driver: bridge
    name: life-assistant-network
